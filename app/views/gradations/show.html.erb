<% content_for :left do %>
	<%= show_course_list %>
<% end %>

<form id='grade_grid'>
<table class='sortable'>
	<thead>
		<tr>
			<th width='150'>Student<br />Name</th>
			<th width='50'>%</th>
		<% for assignment in @gradation.assignments %>
			<th width='50' class='grade' id='<%= assignment.id %>'>
				<%= h assignment.name %><br />
				Possible Points: <%= h assignment.possible_points %><br />
				Due Date: <%= h assignment.due_date.to_s(:due_date) if assignment.due_date %><br />
			</th>
		<% end %>
			<th width='auto'></th>
		</tr>
	</thead>
	<tbody>
		<% counter = 0 %>
		<% for student in @gradation.students %>
			<tr class="calc <%= cycle('odd', 'even') %>"  id='<%= student.id %>' />
				<%= content_tag :td, student.full_name, :id => student.id %>
				<td class='score'>0.0</td>
				<% for assignment in @gradation.assignments %>
					<td class='grades'>
						<% if assignment.gradations[counter] %>
							<%= text_field 'score', assignment.gradations[counter].points_earned, 
									:points => assignment.possible_points,
									:name => 'grade', 
									:value => '10', 
									:size => '10' %>
						<% else %>
							<%= text_field_tag 'score', '', 
									:points => assignment.possible_points,
									:name => 'grade', 
									:size => '10' %>
						<% end %>
					</td>
				<% end %>
				<td></td>
			</tr>
			<% counter += 1 %>
		<% end %>
	
  </tbody>
</table>
</form>

<%#= link_to 'Edit', edit_gradation_path(@gradation) %>
<%#= link_to 'Back', gradations_path %>

<%= link_to_function "Recalculate", "calculate()" %>

<script type="text/javascript">
function calculate() {
	$$('tr.calc').each(calcRowAverage);
}

function calcRowAverage(row) {
  var totalscore;
  var grades;
  var total;
  var count;
  var score;
  var points;

  // Make sure this row has a place to put the average
  totalscore = row.select('td.score')[0];
  if (totalscore) {
    // It does, get the relevant grades
    grades = row.select('input[name^=grade]');

    // Compute the score, allowing for empty/non-numeric cells
    total = 0.0;
    count = 0.0;
    grades.each(function(grade) {
    	// Get the data from the 'grade' element
    	score		= parseFloat(grade.getValue());
    	points	= parseFloat(grade.readAttribute('points'));
    	
    	// Make sure they didn't score more points than possible
    	if (score > points || isNaN(score)) {
    		grade.addClassName('error');
    	} else {    	
    		grade.removeClassName('error');
		  	// Total up the percentage
        total += score / points;
        ++count;
		  }
    });

    // Show the result
    if (count > 0) {
    	original = (total / count)*100
      totalscore.update(Math.round(original*100)/100 + ' %');
    } else {
      totalscore.update('n/a');
    }
  }
}

</script>

<%= observe_form :grade_grid, 
	:url			=> { :action => :update_grade },
	:before		=> "calculate()",
	:with			=> "'grades[score]=' + value"

  %>

<script type="text/javascript">
	// Force a recalculation as soon as the HTML is loaded
  document.observe('dom:loaded', calculate());
</script>
